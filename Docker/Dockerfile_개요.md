# Dockerfile 개요 

커스텀한 Docker 이미지를 만들기 위해서 특정 이미지 기반으로 컨테이너를 올리고 해당 컨테이너 내부에서 직접 필요한 환경 파일들을 구성하고 commit하여 새로운 이미지를 만들어 내는 방법이 있다. 배포 환경을 구성하기 위해 직접 모든 과정을 수행하고 일일이 확인하면서 이미지를 만들 수 있어 확실한 동작을 보장할 수 있는 장점도 있지만, 서살 작업의 효율성 측면에서 고려하면 그리 바람직한 방법은 아닌 것 같다. 이와 같은 비효율적인 작업을 극복하기 위한 것이 `Dockerfile`을 활용하는 방법이다. 
대부분의 경우 커스텀한 이미지를 만들기 위해 `Dokcerfile`을 사용해서 작성합니다.

## Dockerfile이란

도커 이미지 생성을 위한 DSL이다. Docker 이미지가 어떤 단계들을 거쳐서 빌드되어야 하는지에 대한 내용을 담고 있는 파일로 생각하면 된다. Dockerfile은 이 Dockerfile의 스크립트 명령문들을 차례대로 수행하여 이미지를 생성해준다.

<br>

## Dockerfile 포맷

Dockerfile은 기본적으로 다음과 같은 구조를 가진 여러 명령문들로 구성된다.

```
# 주석(Comment)
명령어(Instruction) 인자(Arguments)
```
각 명령문은 명령어로 시작하고 여러 개의 인자가 따라올 수 있고, 인자와 구분하기 쉽도록 명령어는 모두 **영문 대문자**로 작성하는 것이 관례이다.


<br>

## Dockerfile 작성 방법 및 주의점

- Dockerfile은 기본적으로 스크립트이므로 한줄 한줄 해석되어 실행되는 형태이다
- 작성된 한 줄이 곧 하나의 명령어를 이룬다
- Dockerfile에서 명령어는 대문자, 소문자를 구별하지는 않지만 쉘에서 동작하는 커맨드 라인과 구분짓기 위해서 일반적으로 대문자로 표기한다
- Dockerfile은 build 명령어로 이미지를 만들기 시작했을 때 사용자와 상호작용을 보장하지 않는다
  - 따라서 스크립트 내부에 사용자와 상호작용을 요구하는 명령어(예로 패키지 설치 시 yes/no를 선택을 요구하는 메세지)가 실행되어 표준 입력이 활성환되면 build 과정중 이를 오류로 처리하여 스크립트 build진행을 멈춘다
  - 결론은 사용자와 상호작용을 요구하는 명령어에 대해선 `-y` 옵션과 같은 사용자와 상호작용이 필요없도록 미리 모두 처리하는 식으로 명령 스크립트를 작성해야한다

<br>

## Dockerfile 자주 쓰이는 명령어

- FROM 명령문
```
FROM <이미지>
FROM <이미지>:<태그>
```
Docker 이미지는 Base 이미지로부터 시작해서 기존 Base 이미지 위에 새로운 이미지를 중첩하여 여러 층(Layer)를 쌓아가며 만들어진다.    
즉, FROM 명령문은 Base 이미지를 지정해주시기 위해서 사용되는 명령어이며 보통 Dockerfile 최상단에 위치한다.

- RUN 명령문
```
RUN ["<커맨드>", "<파라미터>", "<파라미터>"]
RUN <전체 커맨드>
```

RUN 명령문은 마치 쉘에서 커맨드를 실행하는 것 처럼 이미지 빌드 과정에서 필요한 커맨드 라인을 실행하기 위해서 사용되는 명령문이다. 

- WORKDIR 명령문
```
WORKDIR <이동할 경로>
```

WORKDIR 명령문은 쉘의 cd 명령어처럼 컨테이너 상에서 작업할 디렉토리로 전환하기 위해 사용된다. 이 명령문을 통해 작업 디렉토리를 전환 이동하면 그 이후에 실행되는 모든 명령문(CMD, ENTRYPOINT, COPY, ADD)은 해당 작업 디렉토리를 기준으로 실행되는 것이다.

- ENTRYPOINT 명령문
```
ENTRYPOINT ["<커맨드>", "<파라미터1>", "<파라미터2>"]
ENTRYPOINT <전체 커맨드>
```

ENTRYPOINT 명령문은 이미지를 컨테이너로 띄울 때 항상 실행되어야 하는 커맨드를 지정할 때 사용한다. 이 명령문은 Docker 이미지를 마치 하나의 실행 파일처럼 사용할 때 유용하다. 컨테이너가 뜰 때 이 명령문으로 지정된 커맨드가 실행되고 커맨드로 실행된 프로세스가 죽을 때 컨테이너도 따라서 종료되기 때문이다.

- CMD 명령문
```
CMD ["<커맨드>", "<파라미터1>", "<파라미터2>"]
CMD ["<파라미터1>", "<파라미터2>"]
CMD <쩐체 커맨드>
```

CMD 명령문은 해당 이미지를 컨테이너로 띄울 때 디폴트로 실행할 커맨드이거나 ENTRYPOINT 명령문으로 지정된 커맨드에 디폴트로 넘길 파라미터를 지정할 때 사용한다. 

- EXPOSE 명령문

```
EXPOSE <포트>
EXPOSE <포트>/<프로토콜>
```

EXPOSE 명령문은 네트워크 상에서 컨테이너로 들어오는 트래픽을 린스닝하는 포트와 프로토콜을 지정하기 위해서 사용된다. 프로토콜은 TCP, UDP 중 선택할 수 있으며 지정하지 않으면 TCP를 기본값으로 사용하게된다.    
EXPOSE 명령문으로 지정된 포트는 해당 컨테이너의 내부에서만 유효하고 호스트 컴퓨터에서는 이 포트를 바로 접근은 불가능하다. 호스트로부터 특정 포트로의 접근을 허용하기 위해선 docker run 커맨드를 -p 옵션을 통해 호스트 컴퓨터의 특정 포트를 포워딩해주어야 한다.

- COPY/ADD 명령문

```
COPY <src> <dest>
COPY ["<src>, ... <dest>"]
```

COPY 명령문은 호스트 컴퓨터에 있는 디렉토리나 파일을 Docker 이미지 파일 시스템으로 복사하기 위해서 사용된다. 절대경로, 상대 경로 모두 지원하며 상대 경로 사용 시 WORKDIR 명령문으로 작업 디렉토리를 어디로 전환했는지에 대한 상태를 고려해야 한다.    
ADD 명령문은 좀 더 파워풀한 COPY 명령문이라고 할 수 있다. ADD 명령문은 일반 파일 뿐만 아니라 압축 파일이나 네트워크 상의 파일도 사용이 가능하다. 따라서 이러한 특수한 성격의 파일들을 다루는 것이 아니라면 COPY 명령문을 사용할 것을 권장한다.