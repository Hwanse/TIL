# 도커 이미지 빌드 관련 정리

## 도커 이미지, Dockerfile에 대한 간략 정리
도커 이미지는 우분투 같은 운영체제로 구성된 파일 시스템은 물론, 컨테이너 위에서 실행하기 위한 애플리케이션이나 의존하고 있는 라이브러리, 
도구에 어떤 프로세스를 실행할지 등등 실행 환경의 설정 정보까지 포함하는 아카이브다. 즉, Dockerfile은 이런 이미지를 구성하는 순서를 코드로
기술한 것이기 때문에 Dockerfile 자체가 이미지라고 할 수는 없고 이미지를 빌드하기 위한 디자인(틀, 설명서)이라고 비유할 수 있을 것 같다.
<br>
그리고 이미지를 만드는 과정 자체를 **"도커 이미지를 빌드한다"**라고 할 수 있으며, 컨테이너를 실행할 때는 이러한 빌드된 이미지를 가지고 실행한다.

<br>

## 자주 쓰이는 도커 이미지 관련 명령어 모음

### 도커 이미지 빌드

`docker image build -t 이미지명[:태그명] Dockerfile의 경로`

docker image build는 Dockerfile에 기술된 구성에 따라 도커 이미지를 생성하는 명령어다.
 
- -t: 이미지명과 태그명을 붙이는 옵션, 실제로 거의 필수적으로 쓰인다 
- Dockerfile의 경로: 위 명령어에는 반드시 Dockerfile이 필요하다 해당 경로에 Dockerfile이 없다면 명령을 실행할 수 없다


`docker image build -f Dockerfile-test -t example/echo:latest`

docker image build 명령어는 기본저긍로 Dockerfile이라는 이름의 Dockerfile을 찾는다. 그 외 파일명으로 된 Dockerfile을 사용하기 위해
`-f` 옵션을 사용해야한다.

- f: 이미지 빌드 시 사용할 dockerfile의 파일명을 기입하면 해당 dockerfile을 찾는 옵션

`docker image build --pull=true -t example/echo:latest`

docker image build 명령으로 이미지를 빌드하려면 Dockerfile의 FROM 명령문에 지정한 이미지를 레지스트리에서 내려받은 후,
이를 베이스 이미지로 해서 새로운 이미지를 빌드한다. 이때 레지스트리에서 받아온 도커 이미지는 일부러 삭제하지 않는 이상 한 호스트 운영체제에 저장된다.
따라서 다음에 이미지를 빌드할 때 재사용하기 때문에 매번 베이스 이미지를 받아오지는 않는다. 그러나 --pull 옵션을 사용하면 새로운 이미지 다운을 강제한다.
즉, 이미지를 빌드할 때 확실하게 최신 베이스 이미지를 사용하고 싶을 때 다음과 같은 옵션을 사용하여 빌드가 필요하다.    
(단, 도커 허브 등 레지스트리에서 항상 최신 버전이 있는지 체크하고 빌드를 하기 때문에 빌드 속도면에서는 조금 불리하며, 실무에서는 latest 같은 
최신 버전을 지정하는 것을 지양하고 특정 버전 태그로 지정한 베이스 이미지 사용을 권장)

- pull: pull=true 옵션을 지정하면 이미지 빌드 시 베이스 이미지 다운을 강제한다

### 도커 이미지 검색

`docker search [options] 검색키워드`

도커 허브는 도커 이미지 레지스트리로, 마치 깃허브처럼 사용자나 조직 이름으로 리포지토리를 만들 수 있으며, 이 리포지토리를 사용해 도커 이미지를 관리한다.
`docker search` 명령은 도커 허브에 등록된 리포지토리를 검색할 수 있다.

### 도커 이미지 내려받기

`docker image pull [options] 리포지토리명[:태그명]`

도커 레지스트리에서 도커 이미지를 내려 받을 때 사용하는 명령어다. 해당 명령으로 내려받은 이미지는 그대로 도커 컨테이너를 생성하는 데 사용 가능하다.

### 보유한 도커 이미지 리스트 보기

`docker image ls [options] [리포지토리[:태그명]]`

현재 호스트 운영체제(현재 도커 데몬이 동작하는 호스트 환경)에 저장된 이미지 목록을 출력하는 명령어다. docker image pull이나 
docker image build를 통해 내려받은 이미지들이 호스트 운영체제에 저장된다. 

### 이미지에 태그 지정하기

`docker image tag 기반이미지명[:태그명] 새이미지명[:태그]`

도커 이미지 특정 버전에 태그를 붙일 때 사용하는 명령어다. 도커 이미지에 붙은 태그는 이미지의 특정 버전을 구별하기 위해 사용되는 것이다.
IMAGE ID에 `태그명`이라는 별칭을 붙이는 명령인 것이며, 도커 이미지의 태그는 '어떤 특정 이미지 ID를 갖는 도커 이미지를 쉽게 식별'하기 위한 
목적을 가지고 있다. 예로 들어 어떤 애플리케이션의 특정 버전의 이미지를 나타내기 위해 릴리즈 번호를 붙여서 이미지 버전을 관리하는 용도로 사용할 수 있다.
또한, 특정 이미지의 내용을 수정하고 다시 빌드하면 IMAGE ID 값이 달라지고 새로 빌드된 이미지가 자동적으로 latest 태그를 가지게 된다.

**도커 이미지의 버전**

버전이란 구체적으로 어떤 것을 가리키는 것일까? 도커 이미지는 각각 고유의 IMAGE ID 라는 해시값을 가지고 있으며, 이미지마다 다르게 할당된 식별자라고
할 수 있다. 이 때 IMAGE ID가 도커 이미지의 버전 넘버 역할을 한다. 즉, 애플리케이션을 수정하고 이미지를 다시 빌드하면 매번 다른 이미지가 되는 것이며,
원래 같은 이미지였지만 수정된 이후로는 새로운 IMAGE ID 값이 할당되어 새로운 이미지로 생성되는 것이다. 이는 Dockerfile을 편집했을 때, COPY 대상이
되는 파일의 내용이 바뀌어도 IMAGE ID 값이 바뀐다. 도커 이미지의 버전이라는 표현은 엄밀하게 말하면 버전이 다르면 각기 다른 IMAGE ID를 가지고 있는 것이다.

### 이미지를 외부에 공개

`docker image push [options] 리포지토리명[:태그명]`

현재 호스트 환경에 저장된 도커 이미지를 도커 허브 같은 레지스트리에 등록하기 위해 사용한다. 도커 허브는 자신 또는 소속 기관이 소유한 리포지토리에만
이미지를 등록 할 수 있으며 tag 지정 명령어를 통해 도커 이미지의 네임스페이스는 도커 허브ID 와 같이 변경한다. 그리고 이 이미지를 push 명령어를 통해
공개 리포지토리에 등록하면 된다. (단, 공개 리포지토리에 등록한 이미지나 Dockerfile은 패스워드나 API 키 값 같은 민감한 정보를 포함하지 않도록 주의)



